name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 0.5.0)'
        required: true
        type: string
      npm_token:
        description: 'npm auth token for publishing'
        required: true
        type: string
      dry_run:
        description: 'Run without publishing'
        required: false
        type: boolean
        default: false

permissions: {}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Verify main branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "Error: Releases can only be created from the main branch"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Typecheck
        working-directory: apps/web
        run: npm run typecheck

      - name: Lint
        working-directory: apps/web
        run: npm run lint

      - name: Test
        working-directory: apps/web
        run: npm run test

      - name: Build
        working-directory: apps/web
        run: npm run build

      - name: Create tag and GitHub Release
        if: ${{ !inputs.dry_run }}
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const tag = 'v${{ inputs.version }}';
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha
            });
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: tag,
              generate_release_notes: true,
            });
            console.log(`Created release: ${release.html_url}`);

      - name: Publish to npm
        if: ${{ !inputs.dry_run }}
        working-directory: apps/web
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ inputs.npm_token }}

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: echo "Dry run complete â€” quality gates passed. Would release v${{ inputs.version }}"
