name: "PR Review"

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  eslint:
    name: ESLint Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Run ESLint with reviewdog
        uses: reviewdog/action-eslint@5f1b05a078e2a3172d97558e67d6f14608cd8bbc # v1
        with:
          reporter: github-pr-review
          eslint_flags: 'src/'
          workdir: apps/web
          fail_on_error: false

  pr-size-label:
    name: Label PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Calculate PR size and add label
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            // Get PR info
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;

            // Determine size
            let sizeLabel;
            if (totalChanges < 100) {
              sizeLabel = 'size/small';
            } else if (totalChanges < 500) {
              sizeLabel = 'size/medium';
            } else {
              sizeLabel = 'size/large';
            }

            // Remove any existing size labels
            const currentLabels = pr.labels.map(label => label.name);
            const sizeLabels = currentLabels.filter(label => label.startsWith('size/'));

            for (const label of sizeLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                name: label
              });
            }

            // Add the new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel]
            });

            // Post a comment with PR stats
            const comment = `## PR Size Analysis\n\n` +
              `- **Total changes**: ${totalChanges} lines\n` +
              `- **Additions**: ${additions} lines\n` +
              `- **Deletions**: ${deletions} lines\n` +
              `- **Size**: \`${sizeLabel}\`\n\n` +
              `*This label helps reviewers prioritize PRs by size.*`;

            // Check if we already posted a size comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Size Analysis')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }
