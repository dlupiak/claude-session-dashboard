# Data Mapping Guide: ~/.claude File Structure

How the dashboard reads and extracts data from `~/.claude`. Every file is **read-only** — the dashboard never modifies anything in `~/.claude`.

---

## Directory Structure

```
~/.claude/
├── projects/
│   └── <encoded-project-path>/              # e.g. "-Users-foo-Documents-myproject"
│       ├── <session-id>.jsonl               # Main session log
│       └── <session-id>/                    # Lock dir (exists = session active)
│           └── subagents/
│               └── agent-<agent-id>.jsonl   # Subagent session log
├── stats-cache.json                         # Aggregated analytics (generated by Claude Code)
└── history.jsonl                            # Recent command history
```

### Path Encoding

Project directories encode the full path by replacing `/` with `-`:

```
/Users/foo/Documents/myproject  →  -Users-foo-Documents-myproject
```

Decoded by `lib/utils/claude-path.ts` → `decodeProjectDirName()`.

---

## File → Data Extraction Map

### 1. Session JSONL (main)

**Path:** `~/.claude/projects/<dir>/<session-id>.jsonl`

#### Tier 1: Summary (head + tail parsing)

Only the first 15 and last 15 lines are read for the session list. Fast.

| Data Point | Source | Used In |
|---|---|---|
| `sessionId` | Filename (strip `.jsonl`) | Session list, detail page |
| `projectPath` | Directory name decoded | Session list, project filter |
| `projectName` | Last path component | Session cards, project analytics |
| `branch` | `msg.gitBranch` | Session cards |
| `model` | First `assistant` msg → `message.model` | Session cards, model badge |
| `startedAt` | Earliest `msg.timestamp` | Session cards, sorting |
| `lastActiveAt` | Latest `msg.timestamp` | Session cards, active detection |
| `durationMs` | `lastActiveAt - startedAt` | Session cards |
| `messageCount` | Count of user + assistant + system msgs | Session cards |
| `fileSizeBytes` | `fs.stat().size` | Session cards |
| `isActive` | mtime < 2min AND lock dir exists | Active badge, status filter |

#### Tier 2: Full Detail (streaming parse)

Every line is parsed when viewing a session's detail page.

**From `assistant` messages:**

| Data Point | Source Field | Used In |
|---|---|---|
| Token usage | `message.usage.{input,output,cache_read,cache_creation}_tokens` | Token summary, cost estimation |
| Model | `message.model` | Model badges, per-model breakdown |
| Tool calls | `message.content[].type === 'tool_use'` → `name`, `id`, `input` | Tool frequency chart, timeline |
| Agent dispatches | `tool_use` where `name === 'Task'` → `input.subagent_type`, `description`, `model` | Agents panel, timeline swim lanes |
| Skill invocations | `tool_use` where `name === 'Skill'` → `input.skill`, `input.args` | Skills panel, timeline markers |
| Task creation | `tool_use` where `name === 'TaskCreate'` → `input.subject`, `description`, `activeForm` | Tasks panel |
| Task updates | `tool_use` where `name === 'TaskUpdate'` → `input.taskId`, `input.status` | Tasks panel |
| Text content | `message.content[].text` (first 500 chars) | Timeline turn display |
| Stop reason | `message.stop_reason` | Timeline turn metadata |

**From `user` messages:**

| Data Point | Source Field | Used In |
|---|---|---|
| Text content | `message.content[].text` (first 500 chars) | Timeline turn display |
| Task ID assignment | `tool_result` text matching `Task #<id> created` | Links TaskCreate to ID |
| Agent completion stats | `msg.toolUseResult.{totalTokens, totalToolUseCount, totalDurationMs}` | Agent cards |

**From `progress` messages:**

| Data Point | Source Field | Used In |
|---|---|---|
| Agent ID | `data.agentId` | Links agent to subagent JSONL file |
| Agent model (actual) | `data.message.message.model` | Agent cards (overrides requested model) |
| Agent tokens | `data.message.message.usage` | Agent token totals |
| Agent tool calls | `data.message.message.content[].tool_use.name` | Agent tool frequency |

**From `system` messages:**

| Data Point | Source Field | Used In |
|---|---|---|
| Errors | `level === 'error'` → `slug`, `subtype` | Error panel, timeline error markers |

**Skipped:** `type: 'file-history-snapshot'` messages are ignored entirely.

---

### 2. Subagent JSONL

**Path:** `~/.claude/projects/<dir>/<session-id>/subagents/agent-<agent-id>.jsonl`

Only parsed when viewing a session detail that has agent dispatches. Linked via `agentId` from progress messages.

| Data Point | Detection Pattern | Used In |
|---|---|---|
| Injected skills (from agent frontmatter) | `user` msg where `content[0].text` contains `<command-name>SKILL</command-name>` | Agent skill badges (dimmed "context" style) |
| Invoked skills (explicit calls) | `assistant` msg with `tool_use` where `name === 'Skill'` | Agent skill badges (amber style) |

**Scan limit:** Only first 20 messages checked for injected skills (they always appear at the start). Invoked skills scanned across entire file.

---

### 3. Active Session Detection

**Path:** `~/.claude/projects/<dir>/<session-id>/` (directory, not file)

| Check | Condition | Meaning |
|---|---|---|
| File mtime | `<session-id>.jsonl` modified < 2 minutes ago | Session recently active |
| Lock directory | `<session-id>/` directory exists | Claude Code process running |
| **Active** | **Both true** | Session is currently active |

Polled via React Query: 3s when active sessions exist, 30s otherwise.

---

### 4. Stats Cache

**Path:** `~/.claude/stats-cache.json`

Generated by Claude Code (not the dashboard). Validated with Zod schema.

| Data Point | Field | Used In |
|---|---|---|
| Daily activity | `dailyActivity[].{date, messageCount, sessionCount, toolCallCount}` | ActivityChart (bar chart) |
| Token trends | `dailyModelTokens[].{date, tokensByModel}` | TokenTrendChart (stacked area) |
| Model usage | `modelUsage[modelId].{inputTokens, outputTokens, cacheRead, cacheCreation}` | ModelUsageChart (pie), cost estimation |
| Hourly distribution | `hourCounts["0".."23"]` | HourlyDistribution (bar chart) |
| Totals | `totalSessions`, `totalMessages` | Stats summary cards |
| Longest session | `longestSession.{sessionId, duration, messageCount}` | Stats summary card |
| First session | `firstSessionDate` | Stats summary card |

---

### 5. History

**Path:** `~/.claude/history.jsonl`

| Data Point | Field | Used In |
|---|---|---|
| Command text | `display` | Parsed but not yet displayed |
| Timestamp | `timestamp` (unix ms) | — |
| Project | `project` | — |
| Session ID | `sessionId` | — |

Currently parsed but **not surfaced in the UI** (reserved for future use).

---

## Dashboard Cache (write-only)

**Path:** `~/.claude-dashboard/cache/`

The only location the dashboard writes to. Contains pre-parsed data to avoid re-parsing unchanged files.

| File | Contents | Invalidation |
|---|---|---|
| `stats.cache.json` | Parsed stats-cache data | Source file mtime change |

Cache entry format:
```json
{
  "version": 1,
  "sourceFile": "~/.claude/stats-cache.json",
  "sourceMtimeMs": 1708000000000,
  "cachedAt": "2026-02-16T00:00:00Z",
  "data": { ... }
}
```

Write strategy: atomic (write to `.tmp` then rename).

---

## JSONL Message Type Reference

| `type` | Who writes it | What it contains |
|---|---|---|
| `user` | User input or tool results | Commands, tool_result blocks, agent completion stats |
| `assistant` | Claude's response | Text, tool_use blocks (Read, Bash, Task, Skill, etc.), token usage |
| `system` | Claude Code runtime | Errors, warnings, autocompact events |
| `progress` | Subagent execution | Agent tokens, model, tool calls (linked via `parentToolUseID`) |
| `file-history-snapshot` | Claude Code | File state snapshots (ignored by dashboard) |

---

## Data Flow Diagram

```
~/.claude/stats-cache.json ──────── stats-parser.ts ──────────── Stats Page
                                                                  ├── ActivityChart
                                                                  ├── TokenTrendChart
                                                                  ├── ModelUsageChart
                                                                  └── HourlyDistribution

~/.claude/projects/*/             ┌─ project-scanner.ts ────────── Session List
  ├── *.jsonl (sessions) ─────────┤                                 ├── Project filter
  │   ├── HEAD+TAIL ──────────────┤  session-scanner.ts              ├── Session cards
  │   │                           │    parseSummary()                 └── Pagination
  │   └── FULL PARSE ─────────────┤
  │                               │  session-parser.ts ────────── Session Detail
  │                               │    parseDetail()                 ├── Timeline
  │                               │                                  ├── Token summary
  │                               │                                  ├── Tool frequency
  │                               │                                  ├── Agents & Skills
  │                               │                                  ├── Tasks
  │                               │                                  ├── Cost estimation
  │                               │                                  ├── Context window
  │                               │                                  └── Error log
  │                               │
  └── <session-id>/               │
      ├── (lock dir) ─────────────┤  active-detector.ts ─────── Active badge
      └── subagents/              │
          └── agent-*.jsonl ──────┘  parseSubagentSkills() ──── Agent skill badges
```
